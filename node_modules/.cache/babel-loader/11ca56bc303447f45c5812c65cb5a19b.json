{"ast":null,"code":"'use strict';\n\nvar _createClass = function () {\n  function defineProperties(target, props) {\n    for (var i = 0; i < props.length; i++) {\n      var descriptor = props[i];\n      descriptor.enumerable = descriptor.enumerable || false;\n      descriptor.configurable = true;\n      if (\"value\" in descriptor) descriptor.writable = true;\n      Object.defineProperty(target, descriptor.key, descriptor);\n    }\n  }\n\n  return function (Constructor, protoProps, staticProps) {\n    if (protoProps) defineProperties(Constructor.prototype, protoProps);\n    if (staticProps) defineProperties(Constructor, staticProps);\n    return Constructor;\n  };\n}();\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _possibleConstructorReturn(self, call) {\n  if (!self) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self;\n}\n\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass);\n  }\n\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      enumerable: false,\n      writable: true,\n      configurable: true\n    }\n  });\n  if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;\n}\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar _require = require('..'),\n    getUserAgent = _require.getUserAgent;\n\nvar MAX_RECONNECT_ATTEMPTS = 5;\nvar RECONNECT_INTERVAL_MS = 50;\nvar WS_CLOSE_NORMAL = 1000;\nvar toplevel = global.window || global;\nvar WebSocket = toplevel.WebSocket ? toplevel.WebSocket : require('ws');\n\nvar util = require('../../util');\n/**\r\n * Publish events to the Insights gateway.\r\n * @extends EventEmitter\r\n * @emits InsightsPublisher#connected\r\n * @emits InsightsPublisher#disconnected\r\n * @emits InsightsPublisher#reconnecting\r\n */\n\n\nvar InsightsPublisher = function (_EventEmitter) {\n  _inherits(InsightsPublisher, _EventEmitter);\n  /**\r\n   * @param {string} token - Insights gateway token\r\n   * @param {string} sdkName - Name of the SDK using the {@link InsightsPublisher}\r\n   * @param {string} sdkVersion - Version of the SDK using the {@link InsightsPublisher}\r\n   * @param {string} environment - One of 'dev', 'stage' or 'prod'\r\n   * @param {string} realm - Region identifier\r\n   * @param {InsightsPublisherOptions} options - Override default behavior\r\n   */\n\n\n  function InsightsPublisher(token, sdkName, sdkVersion, environment, realm, options) {\n    _classCallCheck(this, InsightsPublisher);\n\n    var _this = _possibleConstructorReturn(this, (InsightsPublisher.__proto__ || Object.getPrototypeOf(InsightsPublisher)).call(this));\n\n    options = Object.assign({\n      gateway: createGateway(environment, realm) + '/v1/VideoEvents',\n      maxReconnectAttempts: MAX_RECONNECT_ATTEMPTS,\n      reconnectIntervalMs: RECONNECT_INTERVAL_MS,\n      userAgent: getUserAgent(),\n      WebSocket: WebSocket\n    }, options);\n    Object.defineProperties(_this, {\n      _connectTimestamp: {\n        value: 0,\n        writable: true\n      },\n      _eventQueue: {\n        value: []\n      },\n      _readyToConnect: {\n        value: util.defer()\n      },\n      _reconnectAttemptsLeft: {\n        value: options.maxReconnectAttempts,\n        writable: true\n      },\n      _ws: {\n        value: null,\n        writable: true\n      },\n      _WebSocket: {\n        value: options.WebSocket\n      }\n    });\n\n    _this._readyToConnect.promise.then(function (_ref) {\n      var roomSid = _ref.roomSid,\n          participantSid = _ref.participantSid;\n      var self = _this;\n\n      _this.on('disconnected', function maybeReconnect(error) {\n        self._session = null;\n\n        if (error && self._reconnectAttemptsLeft > 0) {\n          self.emit('reconnecting');\n          reconnect(self, token, sdkName, sdkVersion, roomSid, participantSid, options);\n          return;\n        }\n\n        self.removeListener('disconnected', maybeReconnect);\n      });\n\n      connect(_this, token, sdkName, sdkVersion, roomSid, participantSid, options);\n    }).catch(function () {// ignore failures to connect\n    });\n\n    return _this;\n  }\n  /**\r\n   * Start connecting to the Insights gateway.\r\n   * @param {string} roomSid\r\n   * @param {string} participantSid\r\n   * @returns {void}\r\n   */\n\n\n  _createClass(InsightsPublisher, [{\n    key: 'connect',\n    value: function connect(roomSid, participantSid) {\n      this._readyToConnect.resolve({\n        roomSid: roomSid,\n        participantSid: participantSid\n      });\n    }\n    /**\r\n     * Publish an event to the Insights gateway.\r\n     * @private\r\n     * @param {*} event\r\n     */\n\n  }, {\n    key: '_publish',\n    value: function _publish(event) {\n      event.session = this._session;\n\n      this._ws.send(JSON.stringify(event));\n    }\n    /**\r\n     * Disconnect from the Insights gateway.\r\n     * @returns {boolean} true if called when connecting/open, false if not\r\n     */\n\n  }, {\n    key: 'disconnect',\n    value: function disconnect() {\n      if (this._ws === null || this._ws.readyState === this._WebSocket.CLOSING || this._ws.readyState === this._WebSocket.CLOSED) {\n        return false;\n      }\n\n      try {\n        this._ws.close();\n      } catch (error) {// Do nothing.\n      }\n\n      this.emit('disconnected');\n      return true;\n    }\n    /**\r\n     * Publish (or queue, if not connected) an event to the Insights gateway.\r\n     * @param {string} groupName - Event group name\r\n     * @param {string} eventName - Event name\r\n     * @param {object} payload - Event payload\r\n     * @returns {boolean} true if queued or published, false if disconnect() called\r\n     */\n\n  }, {\n    key: 'publish',\n    value: function publish(groupName, eventName, payload) {\n      if (this._ws !== null && (this._ws.readyState === this._WebSocket.CLOSING || this._ws.readyState === this._WebSocket.CLOSED)) {\n        return false;\n      }\n\n      var publishOrEnqueue = typeof this._session === 'string' ? this._publish.bind(this) : this._eventQueue.push.bind(this._eventQueue);\n      publishOrEnqueue({\n        group: groupName,\n        name: eventName,\n        payload: payload,\n        timestamp: Date.now(),\n        type: 'event',\n        version: 1\n      });\n      return true;\n    }\n  }]);\n\n  return InsightsPublisher;\n}(EventEmitter);\n/**\r\n * Start connecting to the Insights gateway.\r\n * @private\r\n * @param {InsightsPublisher} publisher\r\n * @param {string} name\r\n * @param {string} token\r\n * @param {string} sdkName\r\n * @param {string} sdkVersion\r\n * @param {string} roomSid\r\n * @param {string} participantSid\r\n * @param {InsightsPublisherOptions} options\r\n */\n\n\nfunction connect(publisher, token, sdkName, sdkVersion, roomSid, participantSid, options) {\n  publisher._connectTimestamp = Date.now();\n  publisher._reconnectAttemptsLeft--;\n  publisher._ws = new options.WebSocket(options.gateway);\n  var ws = publisher._ws;\n  ws.addEventListener('close', function (event) {\n    if (event.code === WS_CLOSE_NORMAL) {\n      publisher.emit('disconnected');\n      return;\n    }\n\n    publisher.emit('disconnected', new Error('WebSocket Error ' + event.code + ': ' + event.reason));\n  });\n  ws.addEventListener('message', function (message) {\n    handleConnectResponse(publisher, JSON.parse(message.data), options);\n  });\n  ws.addEventListener('open', function () {\n    var connectRequest = {\n      type: 'connect',\n      token: token,\n      version: 1\n    };\n    connectRequest.publisher = {\n      name: sdkName,\n      sdkVersion: sdkVersion,\n      userAgent: options.userAgent,\n      participantSid: participantSid,\n      roomSid: roomSid\n    };\n    ws.send(JSON.stringify(connectRequest));\n  });\n}\n/**\r\n * Create the Insights Websocket gateway URL.\r\n * @param {string} environment\r\n * @param {string} realm\r\n * @returns {string}\r\n */\n\n\nfunction createGateway(environment, realm) {\n  return environment === 'prod' ? 'wss://sdkgw.' + realm + '.twilio.com' : 'wss://sdkgw.' + environment + '-' + realm + '.twilio.com';\n}\n/**\r\n * Handle connect response from the Insights gateway.\r\n * @param {InsightsPublisher} publisher\r\n * @param {*} response\r\n * @param {InsightsPublisherOptions} options\r\n */\n\n\nfunction handleConnectResponse(publisher, response, options) {\n  switch (response.type) {\n    case 'connected':\n      publisher._session = response.session;\n      publisher._reconnectAttemptsLeft = options.maxReconnectAttempts;\n\n      publisher._eventQueue.splice(0).forEach(publisher._publish, publisher);\n\n      publisher.emit('connected');\n      break;\n\n    case 'error':\n      publisher._ws.close();\n\n      publisher.emit('disconnected', new Error(response.message));\n      break;\n  }\n}\n/**\r\n * Start re-connecting to the Insights gateway with an appropriate delay based\r\n * on InsightsPublisherOptions#reconnectIntervalMs.\r\n * @private\r\n * @param {InsightsPublisher} publisher\r\n * @param {string} token\r\n * @param {string} sdkName\r\n * @param {string} sdkVersion\r\n * @param {string} roomSid\r\n * @param {string} participantSid\r\n * @param {InsightsPublisherOptions} options\r\n */\n\n\nfunction reconnect(publisher, token, sdkName, sdkVersion, roomSid, participantSid, options) {\n  var connectInterval = Date.now() - publisher._connectTimestamp;\n\n  var timeToWait = options.reconnectIntervalMs - connectInterval;\n\n  if (timeToWait > 0) {\n    setTimeout(function () {\n      connect(publisher, token, sdkName, sdkVersion, roomSid, participantSid, options);\n    }, timeToWait);\n    return;\n  }\n\n  connect(publisher, token, sdkName, sdkVersion, roomSid, participantSid, options);\n}\n/**\r\n * The {@link InsightsPublisher} is connected to the gateway.\r\n * @event InsightsPublisher#connected\r\n */\n\n/**\r\n * The {@link InsightsPublisher} is disconnected from the gateway.\r\n * @event InsightsPublisher#disconnected\r\n * @param {Error} [error] - Optional error if disconnected unintentionally\r\n */\n\n/**\r\n * The {@link InsightsPublisher} is re-connecting to the gateway.\r\n * @event InsightsPublisher#reconnecting\r\n */\n\n/**\r\n * {@link InsightsPublisher} options.\r\n * @typedef {object} InsightsPublisherOptions\r\n * @property {string} [gateway=sdkgw.{environment}-{realm}.twilio.com] - Insights WebSocket gateway url\r\n * @property {number} [maxReconnectAttempts=5] - Max re-connect attempts\r\n * @property {number} [reconnectIntervalMs=50] - Re-connect interval in ms\r\n */\n\n\nmodule.exports = InsightsPublisher;","map":{"version":3,"sources":["C:/Users/USER/Desktop/ARSW III/Twilio/node_modules/twilio-video/es5/util/insightspublisher/index.js"],"names":["_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","Constructor","protoProps","staticProps","prototype","_classCallCheck","instance","TypeError","_possibleConstructorReturn","self","call","ReferenceError","_inherits","subClass","superClass","create","constructor","value","setPrototypeOf","__proto__","EventEmitter","require","_require","getUserAgent","MAX_RECONNECT_ATTEMPTS","RECONNECT_INTERVAL_MS","WS_CLOSE_NORMAL","toplevel","global","window","WebSocket","util","InsightsPublisher","_EventEmitter","token","sdkName","sdkVersion","environment","realm","options","_this","getPrototypeOf","assign","gateway","createGateway","maxReconnectAttempts","reconnectIntervalMs","userAgent","_connectTimestamp","_eventQueue","_readyToConnect","defer","_reconnectAttemptsLeft","_ws","_WebSocket","promise","then","_ref","roomSid","participantSid","on","maybeReconnect","error","_session","emit","reconnect","removeListener","connect","catch","resolve","_publish","event","session","send","JSON","stringify","disconnect","readyState","CLOSING","CLOSED","close","publish","groupName","eventName","payload","publishOrEnqueue","bind","push","group","name","timestamp","Date","now","type","version","publisher","ws","addEventListener","code","Error","reason","message","handleConnectResponse","parse","data","connectRequest","response","splice","forEach","connectInterval","timeToWait","setTimeout","module","exports"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\r\n\r\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\r\n\r\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\r\n\r\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }\r\n\r\nvar EventEmitter = require('events').EventEmitter;\r\n\r\nvar _require = require('..'),\r\n    getUserAgent = _require.getUserAgent;\r\n\r\nvar MAX_RECONNECT_ATTEMPTS = 5;\r\nvar RECONNECT_INTERVAL_MS = 50;\r\nvar WS_CLOSE_NORMAL = 1000;\r\n\r\nvar toplevel = global.window || global;\r\nvar WebSocket = toplevel.WebSocket ? toplevel.WebSocket : require('ws');\r\nvar util = require('../../util');\r\n\r\n/**\r\n * Publish events to the Insights gateway.\r\n * @extends EventEmitter\r\n * @emits InsightsPublisher#connected\r\n * @emits InsightsPublisher#disconnected\r\n * @emits InsightsPublisher#reconnecting\r\n */\r\n\r\nvar InsightsPublisher = function (_EventEmitter) {\r\n  _inherits(InsightsPublisher, _EventEmitter);\r\n\r\n  /**\r\n   * @param {string} token - Insights gateway token\r\n   * @param {string} sdkName - Name of the SDK using the {@link InsightsPublisher}\r\n   * @param {string} sdkVersion - Version of the SDK using the {@link InsightsPublisher}\r\n   * @param {string} environment - One of 'dev', 'stage' or 'prod'\r\n   * @param {string} realm - Region identifier\r\n   * @param {InsightsPublisherOptions} options - Override default behavior\r\n   */\r\n  function InsightsPublisher(token, sdkName, sdkVersion, environment, realm, options) {\r\n    _classCallCheck(this, InsightsPublisher);\r\n\r\n    var _this = _possibleConstructorReturn(this, (InsightsPublisher.__proto__ || Object.getPrototypeOf(InsightsPublisher)).call(this));\r\n\r\n    options = Object.assign({\r\n      gateway: createGateway(environment, realm) + '/v1/VideoEvents',\r\n      maxReconnectAttempts: MAX_RECONNECT_ATTEMPTS,\r\n      reconnectIntervalMs: RECONNECT_INTERVAL_MS,\r\n      userAgent: getUserAgent(),\r\n      WebSocket: WebSocket\r\n    }, options);\r\n\r\n    Object.defineProperties(_this, {\r\n      _connectTimestamp: {\r\n        value: 0,\r\n        writable: true\r\n      },\r\n      _eventQueue: {\r\n        value: []\r\n      },\r\n      _readyToConnect: {\r\n        value: util.defer()\r\n      },\r\n      _reconnectAttemptsLeft: {\r\n        value: options.maxReconnectAttempts,\r\n        writable: true\r\n      },\r\n      _ws: {\r\n        value: null,\r\n        writable: true\r\n      },\r\n      _WebSocket: {\r\n        value: options.WebSocket\r\n      }\r\n    });\r\n\r\n    _this._readyToConnect.promise.then(function (_ref) {\r\n      var roomSid = _ref.roomSid,\r\n          participantSid = _ref.participantSid;\r\n\r\n      var self = _this;\r\n      _this.on('disconnected', function maybeReconnect(error) {\r\n        self._session = null;\r\n        if (error && self._reconnectAttemptsLeft > 0) {\r\n          self.emit('reconnecting');\r\n          reconnect(self, token, sdkName, sdkVersion, roomSid, participantSid, options);\r\n          return;\r\n        }\r\n        self.removeListener('disconnected', maybeReconnect);\r\n      });\r\n      connect(_this, token, sdkName, sdkVersion, roomSid, participantSid, options);\r\n    }).catch(function () {\r\n      // ignore failures to connect\r\n    });\r\n    return _this;\r\n  }\r\n\r\n  /**\r\n   * Start connecting to the Insights gateway.\r\n   * @param {string} roomSid\r\n   * @param {string} participantSid\r\n   * @returns {void}\r\n   */\r\n\r\n\r\n  _createClass(InsightsPublisher, [{\r\n    key: 'connect',\r\n    value: function connect(roomSid, participantSid) {\r\n      this._readyToConnect.resolve({ roomSid: roomSid, participantSid: participantSid });\r\n    }\r\n\r\n    /**\r\n     * Publish an event to the Insights gateway.\r\n     * @private\r\n     * @param {*} event\r\n     */\r\n\r\n  }, {\r\n    key: '_publish',\r\n    value: function _publish(event) {\r\n      event.session = this._session;\r\n      this._ws.send(JSON.stringify(event));\r\n    }\r\n\r\n    /**\r\n     * Disconnect from the Insights gateway.\r\n     * @returns {boolean} true if called when connecting/open, false if not\r\n     */\r\n\r\n  }, {\r\n    key: 'disconnect',\r\n    value: function disconnect() {\r\n      if (this._ws === null || this._ws.readyState === this._WebSocket.CLOSING || this._ws.readyState === this._WebSocket.CLOSED) {\r\n        return false;\r\n      }\r\n\r\n      try {\r\n        this._ws.close();\r\n      } catch (error) {\r\n        // Do nothing.\r\n      }\r\n      this.emit('disconnected');\r\n\r\n      return true;\r\n    }\r\n\r\n    /**\r\n     * Publish (or queue, if not connected) an event to the Insights gateway.\r\n     * @param {string} groupName - Event group name\r\n     * @param {string} eventName - Event name\r\n     * @param {object} payload - Event payload\r\n     * @returns {boolean} true if queued or published, false if disconnect() called\r\n     */\r\n\r\n  }, {\r\n    key: 'publish',\r\n    value: function publish(groupName, eventName, payload) {\r\n      if (this._ws !== null && (this._ws.readyState === this._WebSocket.CLOSING || this._ws.readyState === this._WebSocket.CLOSED)) {\r\n        return false;\r\n      }\r\n\r\n      var publishOrEnqueue = typeof this._session === 'string' ? this._publish.bind(this) : this._eventQueue.push.bind(this._eventQueue);\r\n\r\n      publishOrEnqueue({\r\n        group: groupName,\r\n        name: eventName,\r\n        payload: payload,\r\n        timestamp: Date.now(),\r\n        type: 'event',\r\n        version: 1\r\n      });\r\n\r\n      return true;\r\n    }\r\n  }]);\r\n\r\n  return InsightsPublisher;\r\n}(EventEmitter);\r\n\r\n/**\r\n * Start connecting to the Insights gateway.\r\n * @private\r\n * @param {InsightsPublisher} publisher\r\n * @param {string} name\r\n * @param {string} token\r\n * @param {string} sdkName\r\n * @param {string} sdkVersion\r\n * @param {string} roomSid\r\n * @param {string} participantSid\r\n * @param {InsightsPublisherOptions} options\r\n */\r\n\r\n\r\nfunction connect(publisher, token, sdkName, sdkVersion, roomSid, participantSid, options) {\r\n  publisher._connectTimestamp = Date.now();\r\n  publisher._reconnectAttemptsLeft--;\r\n  publisher._ws = new options.WebSocket(options.gateway);\r\n  var ws = publisher._ws;\r\n\r\n  ws.addEventListener('close', function (event) {\r\n    if (event.code === WS_CLOSE_NORMAL) {\r\n      publisher.emit('disconnected');\r\n      return;\r\n    }\r\n    publisher.emit('disconnected', new Error('WebSocket Error ' + event.code + ': ' + event.reason));\r\n  });\r\n\r\n  ws.addEventListener('message', function (message) {\r\n    handleConnectResponse(publisher, JSON.parse(message.data), options);\r\n  });\r\n\r\n  ws.addEventListener('open', function () {\r\n    var connectRequest = {\r\n      type: 'connect',\r\n      token: token,\r\n      version: 1\r\n    };\r\n\r\n    connectRequest.publisher = {\r\n      name: sdkName,\r\n      sdkVersion: sdkVersion,\r\n      userAgent: options.userAgent,\r\n      participantSid: participantSid,\r\n      roomSid: roomSid\r\n    };\r\n\r\n    ws.send(JSON.stringify(connectRequest));\r\n  });\r\n}\r\n\r\n/**\r\n * Create the Insights Websocket gateway URL.\r\n * @param {string} environment\r\n * @param {string} realm\r\n * @returns {string}\r\n */\r\nfunction createGateway(environment, realm) {\r\n  return environment === 'prod' ? 'wss://sdkgw.' + realm + '.twilio.com' : 'wss://sdkgw.' + environment + '-' + realm + '.twilio.com';\r\n}\r\n\r\n/**\r\n * Handle connect response from the Insights gateway.\r\n * @param {InsightsPublisher} publisher\r\n * @param {*} response\r\n * @param {InsightsPublisherOptions} options\r\n */\r\nfunction handleConnectResponse(publisher, response, options) {\r\n  switch (response.type) {\r\n    case 'connected':\r\n      publisher._session = response.session;\r\n      publisher._reconnectAttemptsLeft = options.maxReconnectAttempts;\r\n      publisher._eventQueue.splice(0).forEach(publisher._publish, publisher);\r\n      publisher.emit('connected');\r\n      break;\r\n    case 'error':\r\n      publisher._ws.close();\r\n      publisher.emit('disconnected', new Error(response.message));\r\n      break;\r\n  }\r\n}\r\n\r\n/**\r\n * Start re-connecting to the Insights gateway with an appropriate delay based\r\n * on InsightsPublisherOptions#reconnectIntervalMs.\r\n * @private\r\n * @param {InsightsPublisher} publisher\r\n * @param {string} token\r\n * @param {string} sdkName\r\n * @param {string} sdkVersion\r\n * @param {string} roomSid\r\n * @param {string} participantSid\r\n * @param {InsightsPublisherOptions} options\r\n */\r\nfunction reconnect(publisher, token, sdkName, sdkVersion, roomSid, participantSid, options) {\r\n  var connectInterval = Date.now() - publisher._connectTimestamp;\r\n  var timeToWait = options.reconnectIntervalMs - connectInterval;\r\n\r\n  if (timeToWait > 0) {\r\n    setTimeout(function () {\r\n      connect(publisher, token, sdkName, sdkVersion, roomSid, participantSid, options);\r\n    }, timeToWait);\r\n    return;\r\n  }\r\n\r\n  connect(publisher, token, sdkName, sdkVersion, roomSid, participantSid, options);\r\n}\r\n\r\n/**\r\n * The {@link InsightsPublisher} is connected to the gateway.\r\n * @event InsightsPublisher#connected\r\n */\r\n\r\n/**\r\n * The {@link InsightsPublisher} is disconnected from the gateway.\r\n * @event InsightsPublisher#disconnected\r\n * @param {Error} [error] - Optional error if disconnected unintentionally\r\n */\r\n\r\n/**\r\n * The {@link InsightsPublisher} is re-connecting to the gateway.\r\n * @event InsightsPublisher#reconnecting\r\n */\r\n\r\n/**\r\n * {@link InsightsPublisher} options.\r\n * @typedef {object} InsightsPublisherOptions\r\n * @property {string} [gateway=sdkgw.{environment}-{realm}.twilio.com] - Insights WebSocket gateway url\r\n * @property {number} [maxReconnectAttempts=5] - Max re-connect attempts\r\n * @property {number} [reconnectIntervalMs=50] - Re-connect interval in ms\r\n */\r\n\r\nmodule.exports = InsightsPublisher;"]},"metadata":{},"sourceType":"script"}