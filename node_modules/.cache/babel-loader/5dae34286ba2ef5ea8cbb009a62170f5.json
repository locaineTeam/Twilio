{"ast":null,"code":"/* globals RTCPeerConnection, RTCRtpTransceiver */\n'use strict';\n\nvar flatMap = require('./').flatMap;\n\nvar guessBrowser = require('./').guessBrowser; // NOTE(mmalavalli): We cache Chrome's sdpSemantics support in order to prevent\n// instantiation of more than one RTCPeerConnection.\n\n\nvar isSdpSemanticsSupported = null;\n/**\r\n * Check if Chrome supports specifying sdpSemantics for an RTCPeerConnection.\r\n * @return {boolean}\r\n */\n\nfunction checkIfSdpSemanticsIsSupported() {\n  if (typeof isSdpSemanticsSupported === 'boolean') {\n    return isSdpSemanticsSupported;\n  }\n\n  if (typeof RTCPeerConnection === 'undefined') {\n    isSdpSemanticsSupported = false;\n    return isSdpSemanticsSupported;\n  }\n\n  try {\n    new RTCPeerConnection({\n      sdpSemantics: 'foo'\n    });\n    isSdpSemanticsSupported = false;\n  } catch (e) {\n    isSdpSemanticsSupported = true;\n  }\n\n  return isSdpSemanticsSupported;\n} // NOTE(mmalavalli): We cache Chrome's SDP format in order to prevent\n// instantiation of more than one RTCPeerConnection.\n\n\nvar chromeSdpFormat = null;\n/**\r\n * Get Chrome's default SDP format.\r\n * @returns {'planb'|'unified'}\r\n */\n\nfunction getChromeDefaultSdpFormat() {\n  if (!chromeSdpFormat) {\n    if (typeof RTCPeerConnection !== 'undefined' && 'addTransceiver' in RTCPeerConnection.prototype) {\n      try {\n        new RTCPeerConnection().addTransceiver('audio');\n        chromeSdpFormat = 'unified';\n      } catch (e) {\n        chromeSdpFormat = 'planb';\n      }\n    } else {\n      chromeSdpFormat = 'planb';\n    }\n  }\n\n  return chromeSdpFormat;\n}\n/**\r\n * Get Chrome's SDP format.\r\n * @param {'plan-b'|'unified-plan'} [sdpSemantics]\r\n * @returns {'planb'|'unified'}\r\n */\n\n\nfunction getChromeSdpFormat(sdpSemantics) {\n  if (!sdpSemantics || !checkIfSdpSemanticsIsSupported()) {\n    return getChromeDefaultSdpFormat();\n  }\n\n  return {\n    'plan-b': 'planb',\n    'unified-plan': 'unified'\n  }[sdpSemantics];\n}\n/**\r\n * Get Safari's default SDP format.\r\n * @returns {'planb'|'unified'}\r\n */\n\n\nfunction getSafariSdpFormat() {\n  return typeof RTCRtpTransceiver !== 'undefined' && 'currentDirection' in RTCRtpTransceiver.prototype ? 'unified' : 'planb';\n}\n/**\r\n * Get the browser's default SDP format.\r\n * @param {'plan-b'|'unified-plan'} [sdpSemantics]\r\n * @returns {'planb'|'unified'}\r\n */\n\n\nfunction getSdpFormat(sdpSemantics) {\n  return {\n    chrome: getChromeSdpFormat(sdpSemantics),\n    firefox: 'unified',\n    safari: getSafariSdpFormat()\n  }[guessBrowser()] || null;\n}\n/**\r\n * Match a pattern across lines, returning the first capture group for any\r\n * matches.\r\n * @param {string} pattern\r\n * @param {string} lines\r\n * @returns {Set<string>} matches\r\n */\n\n\nfunction getMatches(pattern, lines) {\n  var matches = lines.match(new RegExp(pattern, 'gm')) || [];\n  return matches.reduce(function (results, line) {\n    var match = line.match(new RegExp(pattern));\n    return match ? results.add(match[1]) : results;\n  }, new Set());\n}\n/**\r\n * Get a Set of MediaStreamTrack IDs from an SDP.\r\n * @param {string} pattern\r\n * @param {string} sdp\r\n * @returns {Set<string>}\r\n */\n\n\nfunction getTrackIds(pattern, sdp) {\n  return getMatches(pattern, sdp);\n}\n/**\r\n * Get a Set of MediaStreamTrack IDs from a Plan B SDP.\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {Set<string>} trackIds\r\n */\n\n\nfunction getPlanBTrackIds(sdp) {\n  return getTrackIds('^a=ssrc:[0-9]+ +msid:.+ +(.+) *$', sdp);\n}\n/**\r\n * Get a Set of MediaStreamTrack IDs from a Unified Plan SDP.\r\n * @param {string} sdp - Unified Plan SDP\r\n * @returns {Set<string>} trackIds\r\n */\n\n\nfunction getUnifiedPlanTrackIds(sdp) {\n  return getTrackIds('^a=msid:.+ +(.+) *$', sdp);\n}\n/**\r\n * Get a Set of SSRCs for a MediaStreamTrack from a Plan B SDP.\r\n * @param {string} sdp - Plan B SDP\r\n * @param {string} trackId - MediaStreamTrack ID\r\n * @returns {Set<string>}\r\n */\n\n\nfunction getPlanBSSRCs(sdp, trackId) {\n  var pattern = '^a=ssrc:([0-9]+) +msid:[^ ]+ +' + trackId + ' *$';\n  return getMatches(pattern, sdp);\n}\n/**\r\n * Get the m= sections of a particular kind and direction from an sdp.\r\n * @param {string} sdp -  sdp string\r\n * @param {string} [kind] - Pattern for matching kind\r\n * @param {string} [direction] - Pattern for matching direction\r\n * @returns {Array<string>} mediaSections\r\n */\n\n\nfunction getMediaSections(sdp, kind, direction) {\n  kind = kind || '.*';\n  direction = direction || '.*';\n  return sdp.split('\\r\\nm=').slice(1).map(function (mediaSection) {\n    return 'm=' + mediaSection;\n  }).filter(function (mediaSection) {\n    var kindPattern = new RegExp('m=' + kind, 'gm');\n    var directionPattern = new RegExp('a=' + direction, 'gm');\n    return kindPattern.test(mediaSection) && directionPattern.test(mediaSection);\n  });\n}\n/**\r\n * Get the Set of SSRCs announced in a MediaSection.\r\n * @param {string} mediaSection\r\n * @returns {Array<string>} ssrcs\r\n */\n\n\nfunction getMediaSectionSSRCs(mediaSection) {\n  return Array.from(getMatches('^a=ssrc:([0-9]+) +.*$', mediaSection));\n}\n/**\r\n * Get a Set of SSRCs for a MediaStreamTrack from a Unified Plan SDP.\r\n * @param {string} sdp - Unified Plan SDP\r\n * @param {string} trackId - MediaStreamTrack ID\r\n * @returns {Set<string>}\r\n */\n\n\nfunction getUnifiedPlanSSRCs(sdp, trackId) {\n  var mediaSections = getMediaSections(sdp);\n  var msidAttrRegExp = new RegExp('^a=msid:[^ ]+ +' + trackId + ' *$', 'gm');\n  var matchingMediaSections = mediaSections.filter(function (mediaSection) {\n    return mediaSection.match(msidAttrRegExp);\n  });\n  return new Set(flatMap(matchingMediaSections, getMediaSectionSSRCs));\n}\n/**\r\n * Get a Map from MediaStreamTrack IDs to SSRCs from an SDP.\r\n * @param {function(string): Set<string>} getTrackIds\r\n * @param {function(string, string): Set<string>} getSSRCs\r\n * @param {string} sdp - SDP\r\n * @returns {Map<string, Set<string>>} trackIdsToSSRCs\r\n */\n\n\nfunction getTrackIdsToSSRCs(getTrackIds, getSSRCs, sdp) {\n  return new Map(Array.from(getTrackIds(sdp)).map(function (trackId) {\n    return [trackId, getSSRCs(sdp, trackId)];\n  }));\n}\n/**\r\n * Get a Map from MediaStreamTrack IDs to SSRCs from a Plan B SDP.\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {Map<string, Set<string>>} trackIdsToSSRCs\r\n */\n\n\nfunction getPlanBTrackIdsToSSRCs(sdp) {\n  return getTrackIdsToSSRCs(getPlanBTrackIds, getPlanBSSRCs, sdp);\n}\n/**\r\n * Get a Map from MediaStreamTrack IDs to SSRCs from a Plan B SDP.\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {Map<string, Set<string>>} trackIdsToSSRCs\r\n */\n\n\nfunction getUnifiedPlanTrackIdsToSSRCs(sdp) {\n  return getTrackIdsToSSRCs(getUnifiedPlanTrackIds, getUnifiedPlanSSRCs, sdp);\n}\n/**\r\n * Update the mappings from MediaStreamTrack IDs to SSRCs as indicated by both\r\n * the Map from MediaStreamTrack IDs to SSRCs and the SDP itself. This method\r\n * ensures that SSRCs never change once announced.\r\n * @param {function(string): Map<string, Set<string>>} getTrackIdsToSSRCs\r\n * @param {Map<string, Set<string>>} trackIdsToSSRCs\r\n * @param {string} sdp - SDP\r\n * @returns {strinng} updatedSdp - updated SDP\r\n */\n\n\nfunction updateTrackIdsToSSRCs(getTrackIdsToSSRCs, trackIdsToSSRCs, sdp) {\n  var newTrackIdsToSSRCs = getTrackIdsToSSRCs(sdp);\n  var newSSRCsToOldSSRCs = new Map(); // NOTE(mroberts): First, update a=ssrc attributes.\n\n  newTrackIdsToSSRCs.forEach(function (ssrcs, trackId) {\n    if (!trackIdsToSSRCs.has(trackId)) {\n      trackIdsToSSRCs.set(trackId, ssrcs);\n      return;\n    }\n\n    var oldSSRCs = Array.from(trackIdsToSSRCs.get(trackId));\n    var newSSRCs = Array.from(ssrcs);\n    oldSSRCs.forEach(function (oldSSRC, i) {\n      var newSSRC = newSSRCs[i];\n      newSSRCsToOldSSRCs.set(newSSRC, oldSSRC);\n      var pattern = '^a=ssrc:' + newSSRC + ' (.*)$';\n      var replacement = 'a=ssrc:' + oldSSRC + ' $1';\n      sdp = sdp.replace(new RegExp(pattern, 'gm'), replacement);\n    });\n  }); // NOTE(mroberts): Then, update a=ssrc-group attributes.\n\n  var pattern = '^(a=ssrc-group:[^ ]+ +)(.*)$';\n  var matches = sdp.match(new RegExp(pattern, 'gm')) || [];\n  matches.forEach(function (line) {\n    var match = line.match(new RegExp(pattern));\n\n    if (!match) {\n      return;\n    }\n\n    var prefix = match[1];\n    var newSSRCs = match[2];\n    var oldSSRCs = newSSRCs.split(' ').map(function (newSSRC) {\n      var oldSSRC = newSSRCsToOldSSRCs.get(newSSRC);\n      return oldSSRC ? oldSSRC : newSSRC;\n    }).join(' ');\n    sdp = sdp.replace(match[0], prefix + oldSSRCs);\n  });\n  return sdp;\n}\n/**\r\n * Update the mappings from MediaStreamTrack IDs to SSRCs as indicated by both\r\n * the Map from MediaStreamTrack IDs to SSRCs and the Plan B SDP itself. This\r\n * method ensures that SSRCs never change once announced.\r\n * @param {Map<string, Set<string>>} trackIdsToSSRCs\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {string} updatedSdp - updated Plan B SDP\r\n */\n\n\nfunction updatePlanBTrackIdsToSSRCs(trackIdsToSSRCs, sdp) {\n  return updateTrackIdsToSSRCs(getPlanBTrackIdsToSSRCs, trackIdsToSSRCs, sdp);\n}\n/**\r\n * Update the mappings from MediaStreamTrack IDs to SSRCs as indicated by both\r\n * the Map from MediaStreamTrack IDs to SSRCs and the Plan B SDP itself. This\r\n * method ensures that SSRCs never change once announced.\r\n * @param {Map<string, Set<string>>} trackIdsToSSRCs\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {string} updatedSdp - updated Plan B SDP\r\n */\n\n\nfunction updateUnifiedPlanTrackIdsToSSRCs(trackIdsToSSRCs, sdp) {\n  return updateTrackIdsToSSRCs(getUnifiedPlanTrackIdsToSSRCs, trackIdsToSSRCs, sdp);\n}\n\nexports.getSdpFormat = getSdpFormat;\nexports.getMediaSections = getMediaSections;\nexports.getPlanBTrackIds = getPlanBTrackIds;\nexports.getUnifiedPlanTrackIds = getUnifiedPlanTrackIds;\nexports.getPlanBSSRCs = getPlanBSSRCs;\nexports.getUnifiedPlanSSRCs = getUnifiedPlanSSRCs;\nexports.updatePlanBTrackIdsToSSRCs = updatePlanBTrackIdsToSSRCs;\nexports.updateUnifiedPlanTrackIdsToSSRCs = updateUnifiedPlanTrackIdsToSSRCs;","map":{"version":3,"sources":["C:/Users/USER/Desktop/ARSW III/Twilio/node_modules/@twilio/webrtc/lib/util/sdp.js"],"names":["flatMap","require","guessBrowser","isSdpSemanticsSupported","checkIfSdpSemanticsIsSupported","RTCPeerConnection","sdpSemantics","e","chromeSdpFormat","getChromeDefaultSdpFormat","prototype","addTransceiver","getChromeSdpFormat","getSafariSdpFormat","RTCRtpTransceiver","getSdpFormat","chrome","firefox","safari","getMatches","pattern","lines","matches","match","RegExp","reduce","results","line","add","Set","getTrackIds","sdp","getPlanBTrackIds","getUnifiedPlanTrackIds","getPlanBSSRCs","trackId","getMediaSections","kind","direction","split","slice","map","mediaSection","filter","kindPattern","directionPattern","test","getMediaSectionSSRCs","Array","from","getUnifiedPlanSSRCs","mediaSections","msidAttrRegExp","matchingMediaSections","getTrackIdsToSSRCs","getSSRCs","Map","getPlanBTrackIdsToSSRCs","getUnifiedPlanTrackIdsToSSRCs","updateTrackIdsToSSRCs","trackIdsToSSRCs","newTrackIdsToSSRCs","newSSRCsToOldSSRCs","forEach","ssrcs","has","set","oldSSRCs","get","newSSRCs","oldSSRC","i","newSSRC","replacement","replace","prefix","join","updatePlanBTrackIdsToSSRCs","updateUnifiedPlanTrackIdsToSSRCs","exports"],"mappings":"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","sourcesContent":["/* globals RTCPeerConnection, RTCRtpTransceiver */\r\n\r\n'use strict';\r\n\r\nvar flatMap = require('./').flatMap;\r\nvar guessBrowser = require('./').guessBrowser;\r\n\r\n// NOTE(mmalavalli): We cache Chrome's sdpSemantics support in order to prevent\r\n// instantiation of more than one RTCPeerConnection.\r\nvar isSdpSemanticsSupported = null;\r\n\r\n/**\r\n * Check if Chrome supports specifying sdpSemantics for an RTCPeerConnection.\r\n * @return {boolean}\r\n */\r\nfunction checkIfSdpSemanticsIsSupported() {\r\n  if (typeof isSdpSemanticsSupported === 'boolean') {\r\n    return isSdpSemanticsSupported;\r\n  }\r\n  if (typeof RTCPeerConnection === 'undefined') {\r\n    isSdpSemanticsSupported = false;\r\n    return isSdpSemanticsSupported;\r\n  }\r\n  try {\r\n    new RTCPeerConnection({ sdpSemantics: 'foo' });\r\n    isSdpSemanticsSupported = false;\r\n  } catch (e) {\r\n    isSdpSemanticsSupported = true;\r\n  }\r\n  return isSdpSemanticsSupported;\r\n}\r\n\r\n// NOTE(mmalavalli): We cache Chrome's SDP format in order to prevent\r\n// instantiation of more than one RTCPeerConnection.\r\nvar chromeSdpFormat = null;\r\n\r\n/**\r\n * Get Chrome's default SDP format.\r\n * @returns {'planb'|'unified'}\r\n */\r\nfunction getChromeDefaultSdpFormat() {\r\n  if (!chromeSdpFormat) {\r\n    if (typeof RTCPeerConnection !== 'undefined'\r\n      && 'addTransceiver' in RTCPeerConnection.prototype) {\r\n      try {\r\n        new RTCPeerConnection().addTransceiver('audio');\r\n        chromeSdpFormat = 'unified';\r\n      } catch (e) {\r\n        chromeSdpFormat = 'planb';\r\n      }\r\n    } else {\r\n      chromeSdpFormat = 'planb';\r\n    }\r\n  }\r\n  return chromeSdpFormat;\r\n}\r\n\r\n/**\r\n * Get Chrome's SDP format.\r\n * @param {'plan-b'|'unified-plan'} [sdpSemantics]\r\n * @returns {'planb'|'unified'}\r\n */\r\nfunction getChromeSdpFormat(sdpSemantics) {\r\n  if (!sdpSemantics || !checkIfSdpSemanticsIsSupported()) {\r\n    return getChromeDefaultSdpFormat();\r\n  }\r\n  return {\r\n    'plan-b': 'planb',\r\n    'unified-plan': 'unified'\r\n  }[sdpSemantics];\r\n}\r\n\r\n/**\r\n * Get Safari's default SDP format.\r\n * @returns {'planb'|'unified'}\r\n */\r\nfunction getSafariSdpFormat() {\r\n  return typeof RTCRtpTransceiver !== 'undefined'\r\n    && 'currentDirection' in RTCRtpTransceiver.prototype\r\n      ? 'unified'\r\n      : 'planb';\r\n}\r\n\r\n/**\r\n * Get the browser's default SDP format.\r\n * @param {'plan-b'|'unified-plan'} [sdpSemantics]\r\n * @returns {'planb'|'unified'}\r\n */\r\nfunction getSdpFormat(sdpSemantics) {\r\n  return {\r\n    chrome: getChromeSdpFormat(sdpSemantics),\r\n    firefox: 'unified',\r\n    safari: getSafariSdpFormat()\r\n  }[guessBrowser()] || null;\r\n}\r\n\r\n/**\r\n * Match a pattern across lines, returning the first capture group for any\r\n * matches.\r\n * @param {string} pattern\r\n * @param {string} lines\r\n * @returns {Set<string>} matches\r\n */\r\nfunction getMatches(pattern, lines) {\r\n  var matches = lines.match(new RegExp(pattern, 'gm')) || [];\r\n  return matches.reduce(function(results, line) {\r\n    var match = line.match(new RegExp(pattern));\r\n    return match ? results.add(match[1]) : results;\r\n  }, new Set());\r\n}\r\n\r\n/**\r\n * Get a Set of MediaStreamTrack IDs from an SDP.\r\n * @param {string} pattern\r\n * @param {string} sdp\r\n * @returns {Set<string>}\r\n */\r\nfunction getTrackIds(pattern, sdp) {\r\n  return getMatches(pattern, sdp);\r\n}\r\n\r\n/**\r\n * Get a Set of MediaStreamTrack IDs from a Plan B SDP.\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {Set<string>} trackIds\r\n */\r\nfunction getPlanBTrackIds(sdp) {\r\n  return getTrackIds('^a=ssrc:[0-9]+ +msid:.+ +(.+) *$', sdp);\r\n}\r\n\r\n/**\r\n * Get a Set of MediaStreamTrack IDs from a Unified Plan SDP.\r\n * @param {string} sdp - Unified Plan SDP\r\n * @returns {Set<string>} trackIds\r\n */\r\nfunction getUnifiedPlanTrackIds(sdp) {\r\n  return getTrackIds('^a=msid:.+ +(.+) *$', sdp);\r\n}\r\n\r\n/**\r\n * Get a Set of SSRCs for a MediaStreamTrack from a Plan B SDP.\r\n * @param {string} sdp - Plan B SDP\r\n * @param {string} trackId - MediaStreamTrack ID\r\n * @returns {Set<string>}\r\n */\r\nfunction getPlanBSSRCs(sdp, trackId) {\r\n  var pattern = '^a=ssrc:([0-9]+) +msid:[^ ]+ +' + trackId + ' *$';\r\n  return getMatches(pattern, sdp);\r\n}\r\n\r\n/**\r\n * Get the m= sections of a particular kind and direction from an sdp.\r\n * @param {string} sdp -  sdp string\r\n * @param {string} [kind] - Pattern for matching kind\r\n * @param {string} [direction] - Pattern for matching direction\r\n * @returns {Array<string>} mediaSections\r\n */\r\nfunction getMediaSections(sdp, kind, direction) {\r\n  kind = kind || '.*';\r\n  direction = direction || '.*';\r\n  return sdp.split('\\r\\nm=').slice(1).map(function(mediaSection) {\r\n    return 'm=' + mediaSection;\r\n  }).filter(function(mediaSection) {\r\n    var kindPattern = new RegExp('m=' + kind, 'gm');\r\n    var directionPattern = new RegExp('a=' + direction, 'gm');\r\n    return kindPattern.test(mediaSection) && directionPattern.test(mediaSection);\r\n  });\r\n}\r\n\r\n/**\r\n * Get the Set of SSRCs announced in a MediaSection.\r\n * @param {string} mediaSection\r\n * @returns {Array<string>} ssrcs\r\n */\r\nfunction getMediaSectionSSRCs(mediaSection) {\r\n  return Array.from(getMatches('^a=ssrc:([0-9]+) +.*$', mediaSection));\r\n}\r\n\r\n/**\r\n * Get a Set of SSRCs for a MediaStreamTrack from a Unified Plan SDP.\r\n * @param {string} sdp - Unified Plan SDP\r\n * @param {string} trackId - MediaStreamTrack ID\r\n * @returns {Set<string>}\r\n */\r\nfunction getUnifiedPlanSSRCs(sdp, trackId) {\r\n  var mediaSections = getMediaSections(sdp);\r\n\r\n  var msidAttrRegExp = new RegExp('^a=msid:[^ ]+ +' + trackId + ' *$', 'gm');\r\n  var matchingMediaSections = mediaSections.filter(function(mediaSection) {\r\n    return mediaSection.match(msidAttrRegExp);\r\n  });\r\n\r\n  return new Set(flatMap(matchingMediaSections, getMediaSectionSSRCs));\r\n}\r\n\r\n/**\r\n * Get a Map from MediaStreamTrack IDs to SSRCs from an SDP.\r\n * @param {function(string): Set<string>} getTrackIds\r\n * @param {function(string, string): Set<string>} getSSRCs\r\n * @param {string} sdp - SDP\r\n * @returns {Map<string, Set<string>>} trackIdsToSSRCs\r\n */\r\nfunction getTrackIdsToSSRCs(getTrackIds, getSSRCs, sdp) {\r\n  return new Map(Array.from(getTrackIds(sdp)).map(function(trackId) {\r\n    return [trackId, getSSRCs(sdp, trackId)];\r\n  }));\r\n}\r\n\r\n/**\r\n * Get a Map from MediaStreamTrack IDs to SSRCs from a Plan B SDP.\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {Map<string, Set<string>>} trackIdsToSSRCs\r\n */\r\nfunction getPlanBTrackIdsToSSRCs(sdp) {\r\n  return getTrackIdsToSSRCs(getPlanBTrackIds, getPlanBSSRCs, sdp);\r\n}\r\n\r\n/**\r\n * Get a Map from MediaStreamTrack IDs to SSRCs from a Plan B SDP.\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {Map<string, Set<string>>} trackIdsToSSRCs\r\n */\r\nfunction getUnifiedPlanTrackIdsToSSRCs(sdp) {\r\n  return getTrackIdsToSSRCs(getUnifiedPlanTrackIds, getUnifiedPlanSSRCs, sdp);\r\n}\r\n\r\n/**\r\n * Update the mappings from MediaStreamTrack IDs to SSRCs as indicated by both\r\n * the Map from MediaStreamTrack IDs to SSRCs and the SDP itself. This method\r\n * ensures that SSRCs never change once announced.\r\n * @param {function(string): Map<string, Set<string>>} getTrackIdsToSSRCs\r\n * @param {Map<string, Set<string>>} trackIdsToSSRCs\r\n * @param {string} sdp - SDP\r\n * @returns {strinng} updatedSdp - updated SDP\r\n */\r\nfunction updateTrackIdsToSSRCs(getTrackIdsToSSRCs, trackIdsToSSRCs, sdp) {\r\n  var newTrackIdsToSSRCs = getTrackIdsToSSRCs(sdp);\r\n  var newSSRCsToOldSSRCs = new Map();\r\n\r\n  // NOTE(mroberts): First, update a=ssrc attributes.\r\n  newTrackIdsToSSRCs.forEach(function(ssrcs, trackId) {\r\n    if (!trackIdsToSSRCs.has(trackId)) {\r\n      trackIdsToSSRCs.set(trackId, ssrcs);\r\n      return;\r\n    }\r\n    var oldSSRCs = Array.from(trackIdsToSSRCs.get(trackId));\r\n    var newSSRCs = Array.from(ssrcs);\r\n    oldSSRCs.forEach(function(oldSSRC, i) {\r\n      var newSSRC = newSSRCs[i];\r\n      newSSRCsToOldSSRCs.set(newSSRC, oldSSRC);\r\n      var pattern = '^a=ssrc:' + newSSRC + ' (.*)$';\r\n      var replacement = 'a=ssrc:' + oldSSRC + ' $1';\r\n      sdp = sdp.replace(new RegExp(pattern, 'gm'), replacement);\r\n    });\r\n  });\r\n\r\n  // NOTE(mroberts): Then, update a=ssrc-group attributes.\r\n  var pattern = '^(a=ssrc-group:[^ ]+ +)(.*)$';\r\n  var matches = sdp.match(new RegExp(pattern, 'gm')) || [];\r\n  matches.forEach(function(line) {\r\n    var match = line.match(new RegExp(pattern));\r\n    if (!match) {\r\n      return;\r\n    }\r\n    var prefix = match[1];\r\n    var newSSRCs = match[2];\r\n    var oldSSRCs = newSSRCs.split(' ').map(function(newSSRC) {\r\n      var oldSSRC = newSSRCsToOldSSRCs.get(newSSRC);\r\n      return oldSSRC ? oldSSRC : newSSRC;\r\n    }).join(' ');\r\n    sdp = sdp.replace(match[0], prefix + oldSSRCs);\r\n  });\r\n\r\n  return sdp;\r\n}\r\n\r\n/**\r\n * Update the mappings from MediaStreamTrack IDs to SSRCs as indicated by both\r\n * the Map from MediaStreamTrack IDs to SSRCs and the Plan B SDP itself. This\r\n * method ensures that SSRCs never change once announced.\r\n * @param {Map<string, Set<string>>} trackIdsToSSRCs\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {string} updatedSdp - updated Plan B SDP\r\n */\r\nfunction updatePlanBTrackIdsToSSRCs(trackIdsToSSRCs, sdp) {\r\n  return updateTrackIdsToSSRCs(getPlanBTrackIdsToSSRCs, trackIdsToSSRCs, sdp);\r\n}\r\n\r\n/**\r\n * Update the mappings from MediaStreamTrack IDs to SSRCs as indicated by both\r\n * the Map from MediaStreamTrack IDs to SSRCs and the Plan B SDP itself. This\r\n * method ensures that SSRCs never change once announced.\r\n * @param {Map<string, Set<string>>} trackIdsToSSRCs\r\n * @param {string} sdp - Plan B SDP\r\n * @returns {string} updatedSdp - updated Plan B SDP\r\n */\r\nfunction updateUnifiedPlanTrackIdsToSSRCs(trackIdsToSSRCs, sdp) {\r\n  return updateTrackIdsToSSRCs(getUnifiedPlanTrackIdsToSSRCs, trackIdsToSSRCs, sdp);\r\n}\r\n\r\nexports.getSdpFormat = getSdpFormat;\r\nexports.getMediaSections = getMediaSections;\r\nexports.getPlanBTrackIds = getPlanBTrackIds;\r\nexports.getUnifiedPlanTrackIds = getUnifiedPlanTrackIds;\r\nexports.getPlanBSSRCs = getPlanBSSRCs;\r\nexports.getUnifiedPlanSSRCs = getUnifiedPlanSSRCs;\r\nexports.updatePlanBTrackIdsToSSRCs = updatePlanBTrackIdsToSSRCs;\r\nexports.updateUnifiedPlanTrackIdsToSSRCs = updateUnifiedPlanTrackIdsToSSRCs;\r\n"]},"metadata":{},"sourceType":"script"}